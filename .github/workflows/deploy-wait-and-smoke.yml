# .github/workflows/deploy-wait-and-smoke.yml
name: Deploy Wait & Smoke

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  deploy-wait-and-smoke:
    runs-on: ubuntu-latest
    env:
      # Optional: if VERCEL_TOKEN not present, we won't call Vercel API.
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      # Optional: if not provided, fall back to production apex/www.
      APEX_URL: ${{ secrets.PROD_URL }}
      WWW_URL: ${{ secrets.WWW_URL }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Verify repo structure
        run: ls -R adminer/apps || true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build SPA
        run: |
          cd adminer/apps/web
          npm ci
          npm run build

      - name: Copy SPA into API public dir
        run: |
          mkdir -p adminer/apps/api/public
          rm -rf adminer/apps/api/public/*
          cp -r adminer/apps/web/dist/* adminer/apps/api/public/

      - name: Guard SPA
        run: |
          chmod +x scripts/guard-spa.sh
          ./scripts/guard-spa.sh

      - name: Ensure Vercel token is available
        run: |
          echo "VERCEL_TOKEN is ${VERCEL_TOKEN:+set}${VERCEL_TOKEN:-unset}"

      - name: Deploy to Vercel
        id: deploy
        timeout-minutes: 10
        run: |
          echo "üöÄ Deploying to Vercel..."
          
          # Check required environment variables
          if [[ -z "${VERCEL_ORG_ID:-}" ]]; then
            echo "‚ùå VERCEL_ORG_ID is not set. Please add it to GitHub Secrets."
            echo "   You can find it by running 'vercel teams ls' locally or checking vercel.com/account"
            exit 1
          fi

          if [[ -z "${VERCEL_PROJECT_ID:-}" ]]; then
            echo "‚ùå VERCEL_PROJECT_ID is not set. Please add it to GitHub Secrets."
            exit 1
          fi
          
          echo "‚úÖ Environment variables verified:"
          echo "   VERCEL_ORG_ID: ${VERCEL_ORG_ID:0:8}..."
          echo "   VERCEL_PROJECT_ID: ${VERCEL_PROJECT_ID:0:8}..."

          # Install Vercel CLI
          npm install -g vercel@latest
          
          # CRITICAL FIX: Pull environment variables and ensure they're available at runtime
          echo "üîó Pulling environment variables for production..."
          vercel pull --yes --environment=production --token "$VERCEL_TOKEN" --scope "$VERCEL_ORG_ID" --cwd adminer/apps/api
          
          # Verify environment variables are available
          echo "üîç Verifying environment variables are accessible..."
          if [ -f "adminer/apps/api/.vercel/.env.production.local" ]; then
            echo "‚úÖ Production environment file found"
            echo "üìã Environment variables available:"
            cat adminer/apps/api/.vercel/.env.production.local | grep -v "^#" | grep -v "^$" || echo "‚ö†Ô∏è  No environment variables found"
          else
            echo "‚ùå Production environment file not found - this may cause runtime errors"
          fi
          
          echo "üèóÔ∏è Building project with environment variables..."
          vercel build --prod --token "$VERCEL_TOKEN" --scope "$VERCEL_ORG_ID" --cwd adminer/apps/api
          
          echo "üöÄ Deploying prebuilt version with runtime environment access..."
          # Deploy with explicit environment variable handling
          vercel deploy --prebuilt --prod --token "$VERCEL_TOKEN" --scope "$VERCEL_ORG_ID" --cwd adminer/apps/api
          
          # CRITICAL: Ensure environment variables are set for the deployment
          echo "üîß Setting runtime environment variables..."
          vercel env pull .env.production.local --environment=production --token "$VERCEL_TOKEN" --scope "$VERCEL_ORG_ID" --cwd adminer/apps/api || echo "‚ö†Ô∏è  Environment pull failed, but continuing..."
          
          # FALLBACK: If the new method fails, try the original working approach
          echo "üîÑ Testing deployment with new method..."
          if ! vercel ls --token "$VERCEL_TOKEN" --prod --cwd adminer/apps/api | grep -q "https://"; then
            echo "‚ö†Ô∏è  New deployment method failed, trying fallback approach..."
            echo "üîÑ Using fallback: vercel --prod (original working method)"
            vercel --prod --token "$VERCEL_TOKEN" --scope "$VERCEL_ORG_ID" --yes --cwd adminer/apps/api
          fi
          
          # Get the deployment URL from the simple deployment
          DEPLOY_URL=$(vercel ls --token "$VERCEL_TOKEN" --prod --cwd adminer/apps/api | grep -o 'https://[^[:space:]]*' | head -n1)
          echo "deployment_url=$DEPLOY_URL" >> "$GITHUB_OUTPUT"
          echo "‚úÖ Deployed to: $DEPLOY_URL"
          
          # Debug: Verify the deployment is accessible
          echo "üîç DEBUG: Verifying deployment is accessible..."
          echo "üîç DEBUG: Testing GET / on $DEPLOY_URL"
          curl -s -o /dev/null -w "HTTP %{http_code} for %{url_effective}\n" "$DEPLOY_URL/" || echo "‚ö†Ô∏è  Initial deployment test failed"
          
          # Debug: Test a few key endpoints
          echo "üîç DEBUG: Testing key endpoints..."
          curl -s -o /dev/null -w "Dashboard: HTTP %{http_code}\n" "$DEPLOY_URL/dashboard" || echo "‚ö†Ô∏è  Dashboard test failed"
          curl -s -o /dev/null -w "Health: HTTP %{http_code}\n" "$DEPLOY_URL/api/consolidated?action=health" || echo "‚ö†Ô∏è  Health test failed"

      - name: Optionally fetch the latest deployment URL from Vercel
        id: vercel
        if: ${{ env.VERCEL_TOKEN != '' }}
        run: |
          set -euo pipefail
          # Try to read the most recent production deployment
          RESP="$(curl -sS -H "Authorization: Bearer $VERCEL_TOKEN" \
            "https://api.vercel.com/v6/deployments?limit=1&target=production")" || true
          if [[ -n "${RESP:-}" && "$RESP" != "forbidden" ]]; then
            URL="$(node -e 'const x=JSON.parse(process.argv[1]||"{}"); const d=x.deployments?.[0]; if(d?.url) console.log("https://"+d.url)' "$(printf '%s' "$RESP")" || true)"
            if [[ -n "${URL:-}" ]]; then
              echo "deployment_url=$URL" >> "$GITHUB_OUTPUT"
              echo "Using Vercel deployment URL: $URL"
            fi
          fi

      - name: Prefer Vercel deployment URL if available
        run: |
          set -euo pipefail
          DEPLOY_URL="${{ steps.vercel.outputs.deployment_url || '' }}"
          if [[ -n "${DEPLOY_URL}" ]]; then
            echo "APEX_URL=$DEPLOY_URL" >> $GITHUB_ENV
            # Derive WWW from apex host if you want (not mandatory for smoke)
            HOST="$(echo "$DEPLOY_URL" | sed -E 's#^https?://##')"
            echo "WWW_URL=https://www.${HOST}" >> $GITHUB_ENV
          fi

      - name: Make smoke executable
        run: chmod +x scripts/smoke.sh

      - name: Wait a bit for edge cache
        run: sleep 20

      - name: Smoke test after deploy
        run: |
          chmod +x scripts/smoke.sh
          ./scripts/smoke.sh "${{ steps.deploy.outputs.deployment_url }}"
        env:
          APEX_URL: ${{ steps.deploy.outputs.deployment_url }}

      - name: Upload smoke debug artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-debug-artifacts
          path: |
            smoke_index.html
            smoke_bundle.js
            smoke_bundle.headers
            headers.txt

      - name: Ensure rollback script is fresh
        run: |
          echo "üîç Verifying rollback script is current..."
          cat scripts/rollback.sh
          echo "‚úÖ Rollback script verified"

      - name: Rollback on smoke failure
        if: false  # TEMPORARILY DISABLED to see actual smoke test error
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "‚ùå Smoke test failed - initiating rollback..."
          echo "üîç ROLLBACK TEMPORARILY DISABLED to see actual smoke test failure"
          echo "üìã Check the smoke test output above to see which specific test is failing"
          echo "üí° Once we fix the smoke test, we can re-enable rollback"
          chmod +x scripts/rollback.sh
          # scripts/rollback.sh  # COMMENTED OUT 